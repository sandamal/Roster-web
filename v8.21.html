<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roster Manager V8 - Gelanigama Interchange</title>

<!-- XLSX and html2pdf (for Excel + PDF) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f4f6f8; margin:18px; color:#333; }
  .container { max-width:1100px; margin:auto; background:#fff; padding:18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  h2 { text-align:center; margin:6px 0 18px; }
  label { display:inline-block; width:130px; vertical-align:top; margin-top:8px; font-weight:600; }
  input[type="text"], input[type="date"], select { width:calc(100% - 140px); padding:8px; margin:6px 0 12px; border-radius:6px; border:1px solid #ccc; }
  input[type="text"] { box-sizing:border-box; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .controls { margin:12px 0; display:flex; gap:8px; flex-wrap:wrap; }
  button { background:#007bff; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  button:hover{background:#0056b3}
  table { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
  th, td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
  th { background:#007bff; color:#fff; }
  .day-duty { background:#cde7f0; color:#000; }
  .night-duty { background:#abd6de; color:#000; }
  .off-duty { background:#fff0f0; color:#333; }
  .booth-header { background:#ffc107; color:#000; font-weight:700; }
  .logo { width:90px; display:block; margin:0 auto 6px; }
  .app-footer { text-align:center; color:#999; font-size:13px; margin-top:20px; font-style:italic; }
  .settings-toggle-btn { background:#444; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; margin-bottom:12px; border:none; }
  #settingsPanel { display:none; background:#eef5ff; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #c9d8ff; }

  @media (max-width:800px){
    label { width:100%; }
    input[type="text"], input[type="date"], select { width:100%; }
  }
</style>
</head>
<body>
<div class="container">

  <img src="https://images.seeklogo.com/logo-png/44/1/expressway-sri-lanka-logo-png_seeklogo-443925.png"
       alt="Logo" class="logo" onerror="this.style.display='none'">

  <h2>Gelanigama Interchange ‚Äî Roster Manager V8</h2>

  <div style="text-align:center; margin-bottom:8px;">
    <button class="settings-toggle-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
  </div>

  <div class="row">
    <label>Start Date</label>
    <input type="date" id="startDate">
  </div>

  <div class="row">
    <label>End Date</label>
    <input type="date" id="endDate">
  </div>

  <!-- Settings Panel -->
  <div id="settingsPanel">
    <div class="row">
      <label>Base Date</label>
      <input type="date" id="baseDate">
    </div>
    <div class="row">
      <label>Base Rotation</label>
      <select id="baseRotation">
        <option value="day1">Day 1</option><option value="day2">Day 2</option><option value="day3">Day 3</option><option value="day4">Day 4</option>
        <option value="night1">Night 1</option><option value="night2">Night 2</option><option value="night3">Night 3</option><option value="night4">Night 4</option>
        <option value="off1">Off 1</option><option value="off2">Off 2</option><option value="off3">Off 3</option><option value="off4">Off 4</option>
      </select>
    </div>
    <div class="row">
      <label>Day Booths (comma)</label>
      <input type="text" id="dayBooths" value="J7,K10,L7,J10,K7,J2-10,M7,J2-7,M9">
    </div>
    <div class="row">
      <label>Night Booths (comma)</label>
      <input type="text" id="nightBooths" value="K19,J19,L22,M19,K21,J2-19,J21,L19,M22">
    </div>
    <div class="row">
      <label>Teller IDs (comma)</label>
      <input type="text" id="tellerList" value="171,164,173,167,163,190,170,197,192">
    </div>

    <div class="controls">
      <button onclick="generateRoster()">üìÖ Generate Roster</button>
      <button onclick="exportToExcel()">üì§ Export Excel</button>
      <button onclick="exportToPDF()">üìÑ Export PDF (A4)</button>
      <button onclick="manualSaveSettings()">üíæ Save Settings</button>
      <button onclick="pushToFirebase()">‚òÅÔ∏è Sync to Cloud</button>
    </div>
  </div>

  <div id="output"></div>

  <div class="app-footer">Developed by <b>Sandamal Epasinghe</b> ‚Äì <i>Roster Manager V7.1</i></div>
</div>

<script>
/* ----------- Firebase ----------- */
const firebaseConfig = {
  apiKey: "AIzaSyC8k7TA2JT95MzoXd2pqoz6ZDzO5G5bfy4",
  authDomain: "gelanigama-tolling-roster.firebaseapp.com",
  databaseURL: "https://gelanigama-tolling-roster-default-rtdb.firebaseio.com",
  projectId: "gelanigama-tolling-roster",
  storageBucket: "gelanigama-tolling-roster.firebasestorage.app",
  messagingSenderId: "1241821233",
  appId: "1:1241821233:web:ab96a584f67e0f32ade510"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const rotationCycle = [
  'day1','day2','day3','day4',
  'night1','night2','night3','night4',
  'off1','off2','off3','off4'
];

/* -------- LOAD SETTINGS FROM FIREBASE -------- */
function loadSettings(){
  db.ref("appSettings").once("value").then(snap=>{
    const s = snap.val();
    if(!s) return;

    baseDate.value     = s.baseDate     || "";
    baseRotation.value = s.baseRotation || "day1";
    startDate.value    = s.startDate    || "";
    endDate.value      = s.endDate      || "";
    dayBooths.value    = s.dayBooths    || "";
    nightBooths.value  = s.nightBooths  || "";
    tellerList.value   = s.tellerList   || "";

    if(startDate.value && endDate.value){
      setTimeout(()=>generateRoster(false),300);
    }
  });
}

window.addEventListener("load", loadSettings);

/* -------- SETTINGS TOGGLE -------- */
function toggleSettings(){
  const panel = document.getElementById("settingsPanel");
  if(panel.style.display === "block"){
    panel.style.display = "none";
    return;
  }
  const pwd = prompt("Enter Settings Password:");
  if(pwd === "1234"){
    panel.style.display = "block";
  }else{
    alert("‚ùå Incorrect Password!");
  }
}

/* -------- SAVE SETTINGS (FIREBASE ONLY) -------- */
function saveSettings(){
  const settings = {
    baseDate: baseDate.value,
    baseRotation: baseRotation.value,
    startDate: startDate.value,
    endDate: endDate.value,
    dayBooths: dayBooths.value,
    nightBooths: nightBooths.value,
    tellerList: tellerList.value
  };

  return db.ref("appSettings").set(settings);
}

function manualSaveSettings(){
  saveSettings().then(()=>{
    alert("‚úÖ Settings saved to cloud");
  });
}

/* -------- GENERATE ROSTER -------- */
function generateRoster(showAlert=true){
  if(!startDate.value || !endDate.value){
    if(showAlert) alert("Please select start & end date");
    return;
  }

  const baseD  = new Date(baseDate.value || startDate.value);
  const startD = new Date(startDate.value);
  const endD   = new Date(endDate.value);
  let rotIndex = rotationCycle.indexOf(baseRotation.value);
  if(rotIndex < 0) rotIndex = 0;

  let dayBoothsArr   = dayBooths.value.split(',').map(x=>x.trim()).filter(Boolean);
  let nightBoothsArr = nightBooths.value.split(',').map(x=>x.trim()).filter(Boolean);
  let tellers        = tellerList.value.split(',').map(x=>x.trim()).filter(Boolean);

  let html = "<table>";
  let diff = Math.floor((startD - baseD)/86400000);
  let rotTellers = [...tellers];

  for(let i=0;i<diff;i++){
    rotIndex = (rotIndex+1)%rotationCycle.length;
    if(!rotationCycle[rotIndex].startsWith("off")){
      rotTellers.unshift(rotTellers.pop());
    }
  }

  let lastShift="", d=new Date(startD);
  let roster={};

  while(d<=endD){
    const ds = d.toISOString().split("T")[0];
    const shift = rotationCycle[rotIndex];
    roster[ds]=[];

    if(shift.startsWith("day")){
      if(lastShift!=="day"){
        html+=`<tr class="booth-header"><td colspan="${dayBoothsArr.length+2}">Day Booths</td></tr>`;
        html+=`<tr><th>Date</th><th>Type</th>`;
        dayBoothsArr.forEach(b=>html+=`<th>${b}</th>`);
        html+="</tr>";
        lastShift="day";
      }
      html+=`<tr class="day-duty"><td>${ds}</td><td>Day</td>`;
      dayBoothsArr.forEach((b,i)=>{
        const t=rotTellers[i%rotTellers.length];
        roster[ds].push({teller:t,booth:b});
        html+=`<td>${t}</td>`;
      });
      html+="</tr>";
      rotTellers.unshift(rotTellers.pop());
    }

    else if(shift.startsWith("night")){
      if(lastShift!=="night"){
        html+=`<tr class="booth-header"><td colspan="${nightBoothsArr.length+2}">Night Booths</td></tr>`;
        html+=`<tr><th>Date</th><th>Type</th>`;
        nightBoothsArr.forEach(b=>html+=`<th>${b}</th>`);
        html+="</tr>";
        lastShift="night";
      }
      html+=`<tr class="night-duty"><td>${ds}</td><td>Night</td>`;
      nightBoothsArr.forEach((b,i)=>{
        const t=rotTellers[i%rotTellers.length];
        roster[ds].push({teller:t,booth:b});
        html+=`<td>${t}</td>`;
      });
      html+="</tr>";
      rotTellers.unshift(rotTellers.pop());
    }

    else{
      if(lastShift!=="off"){
        html+=`<tr class="booth-header"><td colspan="${dayBoothsArr.length+2}">Off Days</td></tr>`;
        html+=`<tr><th>Date</th><th>Type</th><th colspan="${dayBoothsArr.length}">Status</th></tr>`;
        lastShift="off";
      }
      html+=`<tr class="off-duty"><td>${ds}</td><td>Off</td><td colspan="${dayBoothsArr.length}">-- Off Day --</td></tr>`;
    }

    d.setDate(d.getDate()+1);
    rotIndex=(rotIndex+1)%rotationCycle.length;
  }

  html+="</table>";
  output.innerHTML=html;

  db.ref("dailyRosterData").set(roster);
  saveSettings();
}

/* -------- AUTO REGEN -------- */
startDate.addEventListener("change",()=>generateRoster(false));
endDate.addEventListener("change",()=>generateRoster(false));

/* -------- EXPORT -------- */
function exportToExcel(){
  const t=document.querySelector("#output table");
  if(!t) return alert("Generate roster first");
  const wb=XLSX.utils.table_to_book(t,{sheet:"Roster"});
  XLSX.writeFile(wb,"Gelanigama_Roster.xlsx");
}

/* -------- CLOUD PUSH (OPTIONAL) -------- */
function pushToFirebase(){
  alert("Roster already synced automatically ‚úî");
}
</script>

</body>
</html>
