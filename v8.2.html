<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roster Manager V8 - Gelanigama Interchange</title>

<!-- XLSX and html2pdf (for Excel + PDF) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f4f6f8; margin:18px; color:#333; }
  .container { max-width:1100px; margin:auto; background:#fff; padding:18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
  h2 { text-align:center; margin:6px 0 18px; }
  label { display:inline-block; width:130px; vertical-align:top; margin-top:8px; font-weight:600; }
  input[type="text"], input[type="date"], select { width:calc(100% - 140px); padding:8px; margin:6px 0 12px; border-radius:6px; border:1px solid #ccc; }
  input[type="text"] { box-sizing:border-box; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .controls { margin:12px 0; display:flex; gap:8px; flex-wrap:wrap; }
  button { background:#007bff; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  button:hover{background:#0056b3}
  table { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
  th, td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
  th { background:#007bff; color:#fff; }
  .day-duty { background:#cde7f0; color:#000; }
  .night-duty { background:#abd6de; color:#000; }
  .off-duty { background:#fff0f0; color:#333; }
  .booth-header { background:#ffc107; color:#000; font-weight:700; }
  .logo { width:90px; display:block; margin:0 auto 6px; }
  .app-footer { text-align:center; color:#999; font-size:13px; margin-top:20px; font-style:italic; }
  .settings-toggle-btn { background:#444; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; margin-bottom:12px; border:none; }
  #settingsPanel { display:none; background:#eef5ff; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #c9d8ff; }

  @media (max-width:800px){
    label { width:100%; }
    input[type="text"], input[type="date"], select { width:100%; }
  }
</style>
</head>
<body>
<div class="container">

  <img src="https://images.seeklogo.com/logo-png/44/1/expressway-sri-lanka-logo-png_seeklogo-443925.png"
       alt="Logo" class="logo" onerror="this.style.display='none'">

  <h2>Gelanigama Interchange ‚Äî Roster Manager V8</h2>

  <div style="text-align:center; margin-bottom:8px;">
    <button class="settings-toggle-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
  </div>

  <div class="row">
    <label>Start Date</label>
    <input type="date" id="startDate">
  </div>

  <div class="row">
    <label>End Date</label>
    <input type="date" id="endDate">
  </div>

  <!-- Settings Panel -->
  <div id="settingsPanel">
    <div class="row">
      <label>Base Date</label>
      <input type="date" id="baseDate">
    </div>
    <div class="row">
      <label>Base Rotation</label>
      <select id="baseRotation">
        <option value="day1">Day 1</option><option value="day2">Day 2</option><option value="day3">Day 3</option><option value="day4">Day 4</option>
        <option value="night1">Night 1</option><option value="night2">Night 2</option><option value="night3">Night 3</option><option value="night4">Night 4</option>
        <option value="off1">Off 1</option><option value="off2">Off 2</option><option value="off3">Off 3</option><option value="off4">Off 4</option>
      </select>
    </div>
    <div class="row">
      <label>Day Booths (comma)</label>
      <input type="text" id="dayBooths" value="J7,K10,L7,J10,K7,J2-10,M7,J2-7,M9">
    </div>
    <div class="row">
      <label>Night Booths (comma)</label>
      <input type="text" id="nightBooths" value="K19,J19,L22,M19,K21,J2-19,J21,L19,M22">
    </div>
    <div class="row">
      <label>Teller IDs (comma)</label>
      <input type="text" id="tellerList" value="171,164,173,167,163,190,170,197,192">
    </div>

    <div class="controls">
      <button onclick="generateRoster()">üìÖ Generate Roster</button>
      <button onclick="exportToExcel()">üì§ Export Excel</button>
      <button onclick="exportToPDF()">üìÑ Export PDF (A4)</button>
      <button onclick="manualSaveSettings()">üíæ Save Settings</button>
      <button onclick="pushToFirebase()">‚òÅÔ∏è Sync to Cloud</button>
    </div>
  </div>

  <div id="output"></div>

  <div class="app-footer">Developed by <b>Sandamal Epasinghe</b> ‚Äì <i>Roster Manager V7.1</i></div>
</div>

<script>
/* ----------- Firebase ----------- */
const firebaseConfig = {
  apiKey: "AIzaSyC8k7TA2JT95MzoXd2pqoz6ZDzO5G5bfy4",
  authDomain: "gelanigama-tolling-roster.firebaseapp.com",
  databaseURL: "https://gelanigama-tolling-roster-default-rtdb.firebaseio.com",
  projectId: "gelanigama-tolling-roster",
  storageBucket: "gelanigama-tolling-roster.firebasestorage.app",
  messagingSenderId: "1241821233",
  appId: "1:1241821233:web:ab96a584f67e0f32ade510"
};
firebase.initializeApp(firebaseConfig);

const rotationCycle = ['day1','day2','day3','day4','night1','night2','night3','night4','off1','off2','off3','off4'];

/* -------- LOAD SETTINGS (NO POPUP) -------- */
window.onload = function(){
  const s = JSON.parse(localStorage.getItem('rosterSettingsV8'));
  if(s){
    document.getElementById('baseDate').value = s.baseDate || '';
    document.getElementById('baseRotation').value = s.baseRotation || 'day1';
    document.getElementById('startDate').value = s.startDate || '';
    document.getElementById('endDate').value = s.endDate || '';
    document.getElementById('dayBooths').value = s.dayBooths || '';
    document.getElementById('nightBooths').value = s.nightBooths || '';
    document.getElementById('tellerList').value = s.tellerList || '';
  }

  const sd = document.getElementById('startDate').value;
  const ed = document.getElementById('endDate').value;

  if(sd && ed){
    setTimeout(() => generateRoster(false), 300);
  }
};

/* -------- SETTINGS TOGGLE WITH PASSWORD -------- */
function toggleSettings() {
  const panel = document.getElementById("settingsPanel");

  // If already visible ‚Üí hide without asking password
  if (panel.style.display === "block") {
    panel.style.display = "none";
    return;
  }

  // Ask password
  const pwd = prompt("Enter Settings Password:");

  // Change this to your preferred password
  const correctPassword = "1234";

  if (pwd === correctPassword) {
    panel.style.display = "block";
  } else {
    alert("‚ùå Incorrect Password!");
  }
}


/* -------- SAVE ONLY WHEN USER CLICKS -------- */
function manualSaveSettings(){
  saveSettings();
  alert("‚úÖ Settings saved");
}

/* -------- INTERNAL SAVE (NO ALERTS) -------- */
function saveSettings(){
  const settings = {
    baseDate: baseDate.value,
    baseRotation: baseRotation.value,
    startDate: startDate.value,
    endDate: endDate.value,
    dayBooths: dayBooths.value,
    nightBooths: nightBooths.value,
    tellerList: tellerList.value
  };
  localStorage.setItem('rosterSettingsV8', JSON.stringify(settings));
}

/* -------- GENERATE ROSTER -------- */
function generateRoster(showAlert = true){
  const sd = startDate.value;
  const ed = endDate.value;
  if(!sd || !ed){
    if(showAlert) alert("Please select start & end date");
    return;
  }

  const baseD = new Date(baseDate.value || sd);
  const startD = new Date(sd);
  const endD = new Date(ed);
  const baseR = baseRotation.value;

  let dayBoothsArr = dayBooths.value.split(',').map(a=>a.trim()).filter(Boolean);
  let nightBoothsArr = nightBooths.value.split(',').map(a=>a.trim()).filter(Boolean);
  let tellersArr = tellerList.value.split(',').map(a=>a.trim()).filter(Boolean);

  let roster = {};
  let html = "<table>";

  let baseIndex = rotationCycle.indexOf(baseR);
  if(baseIndex < 0) baseIndex = 0;

  let diff = Math.floor((startD - baseD) / 86400000);
  let rotationIndex = baseIndex;

  let rotTellers = [...tellersArr];

  for(let i=0;i<diff;i++){
    rotationIndex = (rotationIndex + 1) % rotationCycle.length;
    if(!rotationCycle[rotationIndex].startsWith("off")){
      rotTellers.unshift(rotTellers.pop());
    }
  }

  let lastShift = "";
  let d = new Date(startD);

  while(d <= endD){
    const ds = d.toISOString().split("T")[0];
    const shift = rotationCycle[rotationIndex];
    roster[ds] = [];

    if(shift.startsWith("day")){
      if(lastShift !== "day"){
        html += `<tr class="booth-header"><td colspan="${dayBoothsArr.length + 2}">Day Booths</td></tr>`;
        html += `<tr><th>Date</th><th>Type</th>`;
        dayBoothsArr.forEach(b => html += `<th>${b}</th>`);
        html += `</tr>`;
        lastShift = "day";
      }

      html += `<tr class="day-duty"><td>${ds}</td><td>Day</td>`;
      for(let i=0;i<dayBoothsArr.length;i++){
        const t = rotTellers[i % rotTellers.length];
        roster[ds].push({ teller:t, booth:dayBoothsArr[i] });
        html += `<td>${t}</td>`;
      }
      html += `</tr>`;
      rotTellers.unshift(rotTellers.pop());

    } else if(shift.startsWith("night")){
      if(lastShift !== "night"){
        html += `<tr class="booth-header"><td colspan="${nightBoothsArr.length + 2}">Night Booths</td></tr>`;
        html += `<tr><th>Date</th><th>Type</th>`;
        nightBoothsArr.forEach(b => html += `<th>${b}</th>`);
        html += `</tr>`;
        lastShift = "night";
      }

      html += `<tr class="night-duty"><td>${ds}</td><td>Night</td>`;
      for(let i=0;i<nightBoothsArr.length;i++){
        const t = rotTellers[i % rotTellers.length];
        roster[ds].push({ teller:t, booth:nightBoothsArr[i] });
        html += `<td>${t}</td>`;
      }
      html += `</tr>`;
      rotTellers.unshift(rotTellers.pop());

    } else {
      if(lastShift !== "off"){
        html += `<tr class="booth-header"><td colspan="${dayBoothsArr.length + 2}">Off Days</td></tr>`;
        html += `<tr><th>Date</th><th>Type</th><th colspan="${dayBoothsArr.length}">Status</th></tr>`;
        lastShift = "off";
      }

      html += `<tr class="off-duty"><td>${ds}</td><td>Off</td><td colspan="${dayBoothsArr.length}">-- Off Day --</td></tr>`;
    }

    d.setDate(d.getDate() + 1);
    rotationIndex = (rotationIndex + 1) % rotationCycle.length;
  }

  html += "</table>";
  output.innerHTML = html;

  localStorage.setItem("dailyRosterData", JSON.stringify(roster));
  saveSettings();
}

/* -------- AUTO GENERATE WHEN DATE CHANGES -------- */
startDate.addEventListener("change", ()=> generateRoster(false));
endDate.addEventListener("change", ()=> generateRoster(false));

/* -------- EXPORT FUNCTIONS -------- */
function exportToExcel(){
  const t = document.querySelector("#output table");
  if(!t) return alert("Generate roster first");
  const wb = XLSX.utils.table_to_book(t, { sheet:"Roster" });
  XLSX.writeFile(wb, "Gelanigama_Roster.xlsx");
}
/* Export PDF (portrait A4, no top whitespace) */
function exportToPDF() {
  const table = document.querySelector("table");
  if (!table) return alert("Please generate the roster first!");

  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const title = `Gelanigama Interchange - ${startDate} - ${endDate} Roster`;

  const logoURL = "https://images.seeklogo.com/logo-png/44/1/expressway-sri-lanka-logo-png_seeklogo-443925.png";

  const printWindow = window.open('', '', 'width=900,height=1000');

  printWindow.document.write(`
    <html>
    <head>
      <title>${title}</title>
      <style>
        @page {
          size: A4 portrait;
          margin: 5mm;          /* üî• Reduce margin (removes top gap) */
        }
        body {
          margin: 0;            /* üî• Remove browser default margin */
          padding-top: 0;       /* üî• No top padding at all */
          font-family: Arial, sans-serif;
          text-align: center;
        }
        .logo {
          width: 55px;
          margin: 0;            /* üî• Remove space above and below logo */
        }
        h2 {
          margin: 2px 0 8px 0;  /* üî• Tight title spacing */
        }
        table {
          width: 100%;
          border-collapse: collapse;
          font-size: 11px;
          margin-top: 5px;
        }
        th, td {
          border: 1px solid #888;
          padding: 4px;
          text-align: center;
        }
        th { background: #007bff; color: white; }
        .day-duty { background-color: #cde7f0; }
        .night-duty { background-color: #abd6de; }
        .off-duty { background-color: #f8d7da; }
        .booth-header { background: #ffc107; font-weight: bold; }
      </style>
    </head>
    <body>
      <img src="${logoURL}" class="logo">
      <h2>${title}</h2>
      ${table.outerHTML}
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  setTimeout(() => {
    printWindow.print();
  }, 400);
}



/* -------- Push to Firebase -------- */
function pushToFirebase(){
  const raw = localStorage.getItem("dailyRosterData");
  if(!raw) return alert("Generate roster first");
  firebase.database().ref("dailyRosterData").set(JSON.parse(raw))
    .then(()=> alert("‚òÅÔ∏è Synced to cloud"))
    .catch(e=> alert("Firebase Error: "+e));
}
</script>
</body>
</html>
